# Image Regeneration Feature Documentation

## Overview

This document describes the complete image regeneration functionality that has been implemented for the jewelry image generation system. The feature allows users to regenerate any previously generated image with modifications, while preserving the original context and storing all regenerations with proper tracking.

## Features Implemented

### 1. User Authentication on All Endpoints
All image generation endpoints now require authentication using Bearer token:
- `upload_ornament` - Generate ornament with white background
- `change_background` - Change ornament background
- `generate_model_with_ornament` - Generate AI model wearing ornament
- `generate_real_model_with_ornament` - Generate real model wearing ornament
- `generate_campaign_shot_advanced` - Generate campaign shots

### 2. User Tracking
- All generated images are now associated with a `user_id` extracted from the JWT token
- Users can only access and regenerate their own images
- Security checks prevent unauthorized access

### 3. Regenerate Image Endpoint
A powerful new endpoint that:
- Takes a previously generated image ID and a new prompt
- Combines the original prompt with the new prompt for context-aware regeneration
- Downloads the previous generated image from Cloudinary
- Generates a new version using Gemini AI
- Stores the new image with proper parent-child relationship tracking
- Supports regenerating regenerated images (infinite chain)

### 4. Get User Images Endpoint
- Fetch all images generated by the authenticated user
- Filter by image type
- Pagination support
- Returns complete image metadata including parent relationships

## Database Schema

### OrnamentMongo Model
```python
class OrnamentMongo(Document):
    prompt = StringField(required=True)
    type = StringField(required=True)
    
    # User tracking
    user_id = StringField()  # JWT user ID
    
    # Regeneration tracking
    parent_image_id = ObjectIdField()  # Reference to parent image
    original_prompt = StringField()    # Original prompt for context
    
    # Image URLs and paths
    uploaded_image_url = URLField()
    generated_image_url = URLField(required=True)
    uploaded_image_path = StringField()
    generated_image_path = StringField()
    
    # Additional fields for specific types
    model_image_url = URLField()
    uploaded_ornament_urls = ListField(URLField())
    
    created_at = DateTimeField(default=datetime.datetime.utcnow)
```

## API Endpoints

### Base URL
```
http://localhost:8000/imgbackendapp/
```

### Authentication
All endpoints require a Bearer token in the Authorization header:
```
Authorization: Bearer <your_jwt_token>
```

### 1. Upload Ornament (White Background)
**Endpoint:** `POST /imgbackendapp/`

**Form Data:**
```
image: File
prompt: String (optional)
background_color: String (default: "white")
```

**Response:**
```json
{
  "success": true,
  "message": "Image generated successfully",
  "uploaded_image_url": "https://cloudinary.com/...",
  "generated_image_url": "https://cloudinary.com/...",
  "prompt": "Remove the background...",
  "ornament_id": 123,
  "type": "white_background"
}
```

### 2. Change Background
**Endpoint:** `POST /imgbackendapp/change_background/`

**Form Data:**
```
ornament_image: File
prompt: String
background_image: File (optional)
background_color: String (optional)
```

**Response:**
```json
{
  "success": true,
  "message": "Background changed successfully",
  "uploaded_image_url": "https://cloudinary.com/...",
  "generated_image_url": "https://cloudinary.com/...",
  "prompt": "...",
  "mongo_id": "507f1f77bcf86cd799439011",
  "type": "background_change"
}
```

### 3. Generate Model with Ornament
**Endpoint:** `POST /imgbackendapp/generate-model/`

**Form Data:**
```
ornament_image: File
prompt: String
pose_style: File (optional)
measurements: String (optional)
```

**Response:**
```json
{
  "status": "success",
  "message": "Generated AI close-up model wearing ornament successfully.",
  "prompt": "...",
  "measurements": "...",
  "uploaded_image_url": "https://cloudinary.com/...",
  "generated_image_url": "https://cloudinary.com/...",
  "mongo_id": "507f1f77bcf86cd799439011",
  "type": "model_with_ornament"
}
```

### 4. Generate Real Model with Ornament
**Endpoint:** `POST /imgbackendapp/generate-real-model/`

**Form Data:**
```
model_image: File
ornament_image: File
prompt: String
pose_style: File (optional)
measurements: String (optional)
```

**Response:**
```json
{
  "status": "success",
  "message": "Generated AI image of the model wearing ornament successfully.",
  "prompt": "...",
  "measurements": "...",
  "model_image_url": "https://cloudinary.com/...",
  "ornament_image_url": "https://cloudinary.com/...",
  "generated_image_url": "https://cloudinary.com/...",
  "mongo_id": "507f1f77bcf86cd799439011",
  "type": "real_model_with_ornament"
}
```

### 5. Generate Campaign Shot
**Endpoint:** `POST /imgbackendapp/generate-campaign-shot/`

**Form Data:**
```
ornament_images: File[] (multiple)
ornament_names: String[] (multiple)
prompt: String
model_type: String ("ai_model" | "real_model")
model_image: File (required if model_type = "real_model")
theme_images: File[] (optional, multiple)
```

**Response:**
```json
{
  "status": "success",
  "message": "Campaign shot generated successfully.",
  "prompt": "...",
  "model_type": "real_model",
  "ornament_names": ["Ring", "Necklace"],
  "uploaded_ornament_urls": ["https://...", "https://..."],
  "model_image_url": "https://cloudinary.com/...",
  "generated_image_url": "https://cloudinary.com/...",
  "mongo_id": "507f1f77bcf86cd799439011",
  "type": "campaign_shot_advanced"
}
```

### 6. Regenerate Image ⭐ NEW
**Endpoint:** `POST /imgbackendapp/regenerate/`

**Form Data:**
```
image_id: String (MongoDB ID of image to regenerate)
prompt: String (new modifications)
```

**How it works:**
1. Fetches the previous image record from MongoDB
2. Verifies user owns the image (security check)
3. Downloads the previous generated image from Cloudinary
4. Combines original prompt with new prompt: `"{original_prompt}. {new_prompt}"`
5. Generates new image using Gemini AI with combined prompt
6. Saves locally and uploads to Cloudinary
7. Creates new MongoDB document with:
   - `parent_image_id`: Reference to previous image
   - `original_prompt`: Preserved from first generation
   - Same uploaded image URL
   - New generated image URL
   - Same `type` as parent

**Response:**
```json
{
  "success": true,
  "message": "Image regenerated successfully",
  "mongo_id": "507f1f77bcf86cd799439012",
  "parent_image_id": "507f1f77bcf86cd799439011",
  "generated_image_url": "https://cloudinary.com/...",
  "uploaded_image_url": "https://cloudinary.com/...",
  "combined_prompt": "Remove the background and replace it with white. Make it more vibrant",
  "original_prompt": "Remove the background and replace it with white",
  "new_prompt": "Make it more vibrant",
  "type": "white_background"
}
```

**Example Usage:**
```javascript
// First generation
const result1 = await uploadOrnament(file, "Make it shine");
// Image ID: "abc123"

// User doesn't like it - regenerate
const result2 = await regenerateImage("abc123", "Add gold accents");
// New image ID: "def456"
// Combined prompt: "Remove the background and replace it with white. Make it shine. Add gold accents"

// Still not satisfied - regenerate again
const result3 = await regenerateImage("def456", "Make it brighter");
// New image ID: "ghi789"
// Combined prompt: "Remove the background and replace it with white. Make it shine. Add gold accents. Make it brighter"
```

### 7. Get User Images ⭐ NEW
**Endpoint:** `GET /imgbackendapp/user-images/`

**Query Parameters:**
```
type: String (optional) - Filter by image type
page: Number (default: 1)
limit: Number (default: 20)
```

**Image Types:**
- `white_background`
- `background_change`
- `model_with_ornament`
- `real_model_with_ornament`
- `campaign_shot_advanced`

**Response:**
```json
{
  "success": true,
  "images": [
    {
      "id": "507f1f77bcf86cd799439011",
      "prompt": "Remove the background...",
      "type": "white_background",
      "uploaded_image_url": "https://cloudinary.com/...",
      "generated_image_url": "https://cloudinary.com/...",
      "created_at": "2025-01-01T10:00:00",
      "parent_image_id": null,
      "original_prompt": "Remove the background..."
    },
    {
      "id": "507f1f77bcf86cd799439012",
      "prompt": "Remove the background... Make it vibrant",
      "type": "white_background",
      "uploaded_image_url": "https://cloudinary.com/...",
      "generated_image_url": "https://cloudinary.com/...",
      "created_at": "2025-01-01T10:05:00",
      "parent_image_id": "507f1f77bcf86cd799439011",
      "original_prompt": "Remove the background..."
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "pages": 5
  }
}
```

## Frontend Integration

### Installation
The API functions are available in `frontend/src/lib/imageApi.js`

### Basic Usage

```javascript
import { 
  uploadOrnament, 
  regenerateImage, 
  getUserImages 
} from '@/lib/imageApi';

// Upload an ornament
const uploadFile = async (file) => {
  try {
    const result = await uploadOrnament(file, "Make it shine", "white");
    console.log("Generated:", result.generated_image_url);
    return result;
  } catch (error) {
    console.error("Upload failed:", error);
  }
};

// Regenerate an image
const regenerate = async (imageId) => {
  try {
    const result = await regenerateImage(imageId, "Add more sparkle");
    console.log("Regenerated:", result.generated_image_url);
    return result;
  } catch (error) {
    console.error("Regeneration failed:", error);
  }
};

// Fetch user's images
const fetchImages = async () => {
  try {
    const result = await getUserImages("white_background", 1, 20);
    console.log("Images:", result.images);
    return result.images;
  } catch (error) {
    console.error("Fetch failed:", error);
  }
};
```

### React Components

See `frontend/src/lib/imageApi.js` for complete React component examples including:
- `ImageRegenerateComponent` - Standalone regeneration form
- `ImageGalleryComponent` - Full gallery with regeneration modal

## User Flow Example

### Typical User Journey:

1. **Login/Authentication**
   - User logs in and receives JWT token
   - Token is stored in localStorage/cookies
   - Token is automatically sent with all API requests

2. **Upload and Generate**
   ```javascript
   const result = await uploadOrnament(imageFile, "elegant design");
   // Returns: mongo_id, generated_image_url, uploaded_image_url
   ```

3. **View Generated Image**
   - Display `result.generated_image_url` to user

4. **User Wants Modifications**
   - User clicks "Regenerate" button
   - Enters new prompt: "make it more vibrant"
   
5. **Regenerate**
   ```javascript
   const newResult = await regenerateImage(
     result.mongo_id,
     "make it more vibrant"
   );
   // New image generated with combined prompt
   ```

6. **Continue Regenerating**
   - User can regenerate the regenerated image
   - Each regeneration preserves the original context
   - All versions are tracked via `parent_image_id`

7. **View Gallery**
   ```javascript
   const gallery = await getUserImages();
   // Shows all images including original and regenerations
   ```

## Security Features

1. **Authentication Required**
   - All endpoints require valid JWT token
   - Middleware validates token and extracts user_id

2. **Authorization Checks**
   - Users can only regenerate their own images
   - `regenerate_image` endpoint verifies ownership

3. **Data Isolation**
   - `get_user_images` only returns the authenticated user's images
   - No cross-user access possible

## Database Queries

### Finding Original Image
```python
# Get the first image in a regeneration chain
def get_original_image(image_id):
    current = OrnamentMongo.objects.get(id=image_id)
    
    while current.parent_image_id:
        current = OrnamentMongo.objects.get(id=current.parent_image_id)
    
    return current
```

### Getting Regeneration History
```python
# Get all regenerations of an image
def get_regeneration_chain(image_id):
    chain = []
    children = OrnamentMongo.objects(parent_image_id=image_id)
    
    for child in children:
        chain.append(child)
        chain.extend(get_regeneration_chain(child.id))
    
    return chain
```

## Error Handling

All endpoints return consistent error responses:

```json
{
  "success": false,
  "error": "Error message here"
}
```

Common errors:
- `401 Unauthorized` - Invalid or missing token
- `403 Forbidden` - User doesn't own the image
- `404 Not Found` - Image ID doesn't exist
- `400 Bad Request` - Missing required parameters
- `500 Internal Server Error` - Server/generation error

## Testing

### Manual Testing with cURL

```bash
# Get JWT token first (from your login endpoint)
TOKEN="your_jwt_token_here"

# Upload ornament
curl -X POST http://localhost:8000/imgbackendapp/ \
  -H "Authorization: Bearer $TOKEN" \
  -F "image=@/path/to/image.jpg" \
  -F "prompt=Make it elegant"

# Regenerate image
curl -X POST http://localhost:8000/imgbackendapp/regenerate/ \
  -H "Authorization: Bearer $TOKEN" \
  -F "image_id=507f1f77bcf86cd799439011" \
  -F "prompt=Add more sparkle"

# Get user images
curl -X GET "http://localhost:8000/imgbackendapp/user-images/?page=1&limit=20" \
  -H "Authorization: Bearer $TOKEN"
```

## Performance Considerations

1. **Cloudinary Downloads**
   - Regeneration downloads previous image from Cloudinary
   - Ensure good network connection
   - Consider caching if regenerating same image multiple times

2. **Gemini API**
   - Generation can take 5-15 seconds
   - Show loading states to users
   - Handle timeouts gracefully

3. **MongoDB Queries**
   - Indexed on `user_id` for fast filtering
   - Indexed on `created_at` for sorting
   - Pagination recommended for large datasets

## Future Enhancements

1. **Batch Regeneration**
   - Regenerate multiple images at once
   
2. **Regeneration Templates**
   - Save common regeneration prompts
   
3. **A/B Testing**
   - Generate multiple variations simultaneously
   
4. **Version Control UI**
   - Visual tree of all regenerations
   - Easy comparison between versions

## Troubleshooting

### Issue: "Token expired"
**Solution:** Refresh the JWT token through your auth system

### Issue: "Image not found"
**Solution:** Ensure the image_id is correct and belongs to the user

### Issue: "Gemini not available"
**Solution:** Check GOOGLE_API_KEY in Django settings. System falls back to OpenCV processing.

### Issue: "Cloudinary upload failed"
**Solution:** Verify Cloudinary credentials in Django settings

## Support

For questions or issues, contact the development team or refer to:
- Backend code: `backend/imgbackend/imgbackendapp/views.py`
- Frontend API: `frontend/src/lib/imageApi.js`
- MongoDB models: `backend/imgbackend/imgbackendapp/mongo_models.py`

---

**Last Updated:** January 2025  
**Version:** 1.0  
**Author:** AI Assistant

