<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project Setup - Collection {{ collection }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { margin-bottom: 20px; }
        h3 { margin-bottom: 10px; }
        label { margin-right: 15px; }
        input[type="file"] { margin-top: 5px; margin-bottom: 15px; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical; font-family: monospace; background: #f9f9f9; }
        button { background: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .ai-prompts { margin-top: 30px; }
        .ai-prompts ul { padding-left: 20px; }
        .ai-prompts li { margin-bottom: 10px; }
        .text-gray { color: #666; font-size: 14px; margin-bottom: 15px; }
        .prompt-card { margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
        .prompt-card:hover { transform: translateY(-2px); }
        .prompt-header { display: flex; align-items: center; padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .prompt-header h4 { margin: 0; flex-grow: 1; color: #333; font-size: 18px; }
        .prompt-type { background: #007bff; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .prompt-content { padding: 20px; background: white; }
        .prompt-content p { margin: 0; line-height: 1.6; color: #444; }
        #generated-images img { max-width: 200px; margin: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        #loading { display: none; font-size: 16px; color: #007bff; margin-top: 15px; }

        /* Specific card colors */
        .white-bg .prompt-header { background: #f0f8ff; }
        .white-bg .prompt-type { background: #4a90e2; }
        .bg-replace .prompt-header { background: #f0fff4; }
        .bg-replace .prompt-type { background: #28a745; }
        .model-img .prompt-header { background: #fff5f5; }
        .model-img .prompt-type { background: #dc3545; }
        .campaign-img .prompt-header { background: #fff8e1; }
        .campaign-img .prompt-type { background: #ff9800; }
        .other-creative .prompt-header { background: #f3e5f5; }
        .other-creative .prompt-type { background: #9c27b0; }

        /* Suggestion categories styling */
        .suggestion-category { margin-bottom: 20px; }
        .category-header { 
            font-weight: bold; 
            margin-bottom: 10px; 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 14px;
        }
        .category-suggested { background: #e3f2fd; color: #1976d2; border-left: 4px solid #2196f3; }
        .category-selected { background: #e8f5e8; color: #2e7d32; border-left: 4px solid #4caf50; }
        .category-both { background: #fff3e0; color: #f57c00; border-left: 4px solid #ff9800; }
        
        .option-item { 
            margin: 8px 0; 
            padding: 8px 12px; 
            border-radius: 6px; 
            transition: all 0.2s ease;
        }
        .option-suggested { background: #f8f9fa; border: 1px solid #dee2e6; }
        .option-selected { background: #d4edda; border: 1px solid #c3e6cb; }
        .option-both { background: #ffeaa7; border: 1px solid #fdcb6e; }
        
        .option-item:hover { transform: translateX(5px); }
        .option-item label { margin: 0; cursor: pointer; display: flex; align-items: center; }
        .option-item input[type="checkbox"] { margin-right: 10px; }
    </style>
</head>
<body>
<div class="container">

    <h2>Project Setup - Collection {{ collection }}</h2>
    
    {% if item_obj.selected_themes or item_obj.selected_backgrounds or item_obj.selected_poses or item_obj.selected_locations or item_obj.selected_colors %}
    <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ðŸ“‹ Your Previous Selections Summary</h4>
        <p style="margin: 5px 0; font-size: 14px;">
            <strong>Themes:</strong> {{ item_obj.selected_themes|join:", "|default:"None" }}<br>
            <strong>Backgrounds:</strong> {{ item_obj.selected_backgrounds|join:", "|default:"None" }}<br>
            <strong>Poses:</strong> {{ item_obj.selected_poses|join:", "|default:"None" }}<br>
            <strong>Locations:</strong> {{ item_obj.selected_locations|join:", "|default:"None" }}<br>
            <strong>Colors:</strong> {{ item_obj.selected_colors|join:", "|default:"None" }}
        </p>
    </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="save">

        <!-- Themes -->
        <div>
            <h3>Themes</h3>
            <p class="text-gray">AI suggestions and your previous selections are organized below. You can select from any category.</p>
            
            {% if themes_categorized.both %}
            <div class="suggestion-category">
                <div class="category-header category-both">âœ“ Previously Selected & AI Suggested</div>
                {% for theme in themes_categorized.both %}
                <div class="option-item option-both">
                    <label>
                        <input type="checkbox" name="themes" value="{{ theme }}" checked>
                        {{ theme }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if themes_categorized.selected_only %}
            <div class="suggestion-category">
                <div class="category-header category-selected">âœ“ Your Previous Selections</div>
                {% for theme in themes_categorized.selected_only %}
                <div class="option-item option-selected">
                    <label>
                        <input type="checkbox" name="themes" value="{{ theme }}" checked>
                        {{ theme }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if themes_categorized.suggested_only %}
            <div class="suggestion-category">
                <div class="category-header category-suggested">ðŸ’¡ AI Suggestions</div>
                {% for theme in themes_categorized.suggested_only %}
                <div class="option-item option-suggested">
                    <label>
                        <input type="checkbox" name="themes" value="{{ theme }}">
                        {{ theme }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <br>
            <input type="file" name="uploaded_theme_images" multiple>
        </div>
    
        <!-- Backgrounds -->
        <div>
            <h3>Backgrounds</h3>
            <p class="text-gray">AI suggestions and your previous selections are organized below. You can select from any category.</p>
            
            {% if backgrounds_categorized.both %}
            <div class="suggestion-category">
                <div class="category-header category-both">âœ“ Previously Selected & AI Suggested</div>
                {% for bg in backgrounds_categorized.both %}
                <div class="option-item option-both">
                    <label>
                        <input type="checkbox" name="backgrounds" value="{{ bg }}" checked>
                        {{ bg }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if backgrounds_categorized.selected_only %}
            <div class="suggestion-category">
                <div class="category-header category-selected">âœ“ Your Previous Selections</div>
                {% for bg in backgrounds_categorized.selected_only %}
                <div class="option-item option-selected">
                    <label>
                        <input type="checkbox" name="backgrounds" value="{{ bg }}" checked>
                        {{ bg }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if backgrounds_categorized.suggested_only %}
            <div class="suggestion-category">
                <div class="category-header category-suggested">ðŸ’¡ AI Suggestions</div>
                {% for bg in backgrounds_categorized.suggested_only %}
                <div class="option-item option-suggested">
                    <label>
                        <input type="checkbox" name="backgrounds" value="{{ bg }}">
                        {{ bg }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <br>
            <input type="file" name="uploaded_background_images" multiple>
        </div>
    
        <!-- Poses -->
        <div>
            <h3>Poses</h3>
            <p class="text-gray">AI suggestions and your previous selections are organized below. You can select from any category.</p>
            
            {% if poses_categorized.both %}
            <div class="suggestion-category">
                <div class="category-header category-both">âœ“ Previously Selected & AI Suggested</div>
                {% for pose in poses_categorized.both %}
                <div class="option-item option-both">
                    <label>
                        <input type="checkbox" name="poses" value="{{ pose }}" checked>
                        {{ pose }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if poses_categorized.selected_only %}
            <div class="suggestion-category">
                <div class="category-header category-selected">âœ“ Your Previous Selections</div>
                {% for pose in poses_categorized.selected_only %}
                <div class="option-item option-selected">
                    <label>
                        <input type="checkbox" name="poses" value="{{ pose }}" checked>
                        {{ pose }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if poses_categorized.suggested_only %}
            <div class="suggestion-category">
                <div class="category-header category-suggested">ðŸ’¡ AI Suggestions</div>
                {% for pose in poses_categorized.suggested_only %}
                <div class="option-item option-suggested">
                    <label>
                        <input type="checkbox" name="poses" value="{{ pose }}">
                        {{ pose }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <br>
            <input type="file" name="uploaded_pose_images" multiple>
        </div>
    
        <!-- Locations -->
        <div>
            <h3>Locations</h3>
            <p class="text-gray">AI suggestions and your previous selections are organized below. You can select from any category.</p>
            
            {% if locations_categorized.both %}
            <div class="suggestion-category">
                <div class="category-header category-both">âœ“ Previously Selected & AI Suggested</div>
                {% for loc in locations_categorized.both %}
                <div class="option-item option-both">
                    <label>
                        <input type="checkbox" name="locations" value="{{ loc }}" checked>
                        {{ loc }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if locations_categorized.selected_only %}
            <div class="suggestion-category">
                <div class="category-header category-selected">âœ“ Your Previous Selections</div>
                {% for loc in locations_categorized.selected_only %}
                <div class="option-item option-selected">
                    <label>
                        <input type="checkbox" name="locations" value="{{ loc }}" checked>
                        {{ loc }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if locations_categorized.suggested_only %}
            <div class="suggestion-category">
                <div class="category-header category-suggested">ðŸ’¡ AI Suggestions</div>
                {% for loc in locations_categorized.suggested_only %}
                <div class="option-item option-suggested">
                    <label>
                        <input type="checkbox" name="locations" value="{{ loc }}">
                        {{ loc }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <br>
            <input type="file" name="uploaded_location_images" multiple>
        </div>
    
        <!-- Colors -->
        <div>
            <h3>Colors</h3>
            <p class="text-gray">AI suggestions and your previous selections are organized below. You can select from any category.</p>
            
            {% if colors_categorized.both %}
            <div class="suggestion-category">
                <div class="category-header category-both">âœ“ Previously Selected & AI Suggested</div>
                {% for color in colors_categorized.both %}
                <div class="option-item option-both">
                    <label>
                        <input type="checkbox" name="colors" value="{{ color }}" checked>
                        {{ color }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if colors_categorized.selected_only %}
            <div class="suggestion-category">
                <div class="category-header category-selected">âœ“ Your Previous Selections</div>
                {% for color in colors_categorized.selected_only %}
                <div class="option-item option-selected">
                    <label>
                        <input type="checkbox" name="colors" value="{{ color }}" checked>
                        {{ color }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if colors_categorized.suggested_only %}
            <div class="suggestion-category">
                <div class="category-header category-suggested">ðŸ’¡ AI Suggestions</div>
                {% for color in colors_categorized.suggested_only %}
                <div class="option-item option-suggested">
                    <label>
                        <input type="checkbox" name="colors" value="{{ color }}">
                        {{ color }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <br>
            <input type="file" name="uploaded_color_images" multiple>
        </div>
    

        <!-- AI Generated Prompts -->
        {% comment %} <div>
            <h3>AI Generated Prompts</h3>
            <p class="text-gray">You can review the existing prompts for reference:</p>
            <textarea name="existing_prompts" rows="15" readonly>{{ detailed_prompt_text }}</textarea>
        </div> {% endcomment %}

        <div style="margin-top: 15px;">
            <button type="submit">Save & Generate Final Moodboard</button>
            <a href="{% url 'probackendapp:generate_ai_images_page' collection.id %}">
                <button type="button" style="margin-left:10px;">Generate AI Model Images</button>
            </a>
        </div>
    </form>

    {% if ai_response %}
    <div class="ai-prompts">
        <h3>Generated Image Prompts</h3>
        <p class="text-gray">AI has generated specialized prompts for different types of images:</p>

        {% if ai_response.white_background %}
        <div class="prompt-card white-bg">
            <div class="prompt-header">
                <h4>White Background Images</h4>
                <span class="prompt-type">Clean & Isolated</span>
            </div>
            <div class="prompt-content">
                <p>{{ ai_response.white_background }}</p>
            </div>
        </div>
        {% endif %}

        {% if ai_response.background_replace %}
        <div class="prompt-card bg-replace">
            <div class="prompt-header">
                <h4>Background Replacement</h4>
                <span class="prompt-type">Themed Backgrounds</span>
            </div>
            <div class="prompt-content">
                <p>{{ ai_response.background_replace }}</p>
            </div>
        </div>
        {% endif %}

        {% if ai_response.model_image %}
        <div class="prompt-card model-img">
            <div class="prompt-header">
                <h4>Model Images</h4>
                <span class="prompt-type">Realistic Models</span>
            </div>
            <div class="prompt-content">
                <p>{{ ai_response.model_image }}</p>
            </div>
        </div>
        {% endif %}

        {% if ai_response.campaign_image %}
        <div class="prompt-card campaign-img">
            <div class="prompt-header">
                <h4>Campaign Shots</h4>
                <span class="prompt-type">Promotional Images</span>
            </div>
            <div class="prompt-content">
                <p>{{ ai_response.campaign_image }}</p>
            </div>
        </div>
        {% endif %}

        <div id="generated-images"></div>
    </div>
    {% endif %}

</div> <!-- Close container -->

<script>
document.addEventListener("DOMContentLoaded", function() {
    const container = document.getElementById("generated-images");
    const loadingText = document.getElementById("loading");
    const btn = document.getElementById("generate-images-btn");

    if (!container || !loadingText || !btn) return;

    btn.addEventListener("click", function() {
        const url = "{% url 'probackendapp:generate_ai_images' collection.id %}";
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        loadingText.style.display = "inline";
        container.innerHTML = "";

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Accept": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingText.style.display = "none";

            if (data.error) {
                alert(data.error);
                return;
            }

            if (data.images && data.images.length > 0) {
                data.images.forEach(src => {
                    const img = document.createElement("img");
                    img.src = src;
                    img.alt = "AI Generated Model";
                    container.appendChild(img);
                });
            }
        })
        .catch(err => {
            loadingText.style.display = "none";
            console.error("Error generating images:", err);
            alert("Failed to generate AI images. Check console.");
        });
    });
});
</script>

</body>
</html>
